# Mini RAG for Industrial Safety Documents

This project implements a lightweight Retrieval-Augmented Generation (RAG) system using FastAPI for the API backend and Streamlit for a user-friendly Q&A interface. It's designed to answer questions based on a collection of industrial safety documents (PDFs).

## Features

- **Document Ingestion:** Processes PDF documents, extracts text, chunks them, and generates embeddings.
- **Hybrid Search API:** Provides a FastAPI endpoint for querying documents using a hybrid approach (vector similarity + BM25 keyword matching).
- **Streamlit Q&A Interface:** A simple web application for interacting with the RAG system.

## Project Structure

- `src/api.py`: The FastAPI application that exposes the `/ask` endpoint for RAG queries.
- `src/ingest.py`: Script for processing PDF documents, chunking, and generating embeddings into `chunks.db`.
- `src/streamlit_app.py`: The Streamlit application for the Q&A interface.
- `src/test_api.py`: Basic test script for the FastAPI.
- `src/performance_test.py`: Script to run a set of diverse questions and generate a performance table.
- `src/chunks.db`: SQLite database storing document chunks and their embeddings (generated by `ingest.py`).
- `src/documents/`: Directory to place your PDF documents.
- `src/sources.json`: Configuration file listing the PDF documents to be ingested.
- `requirements.txt`: Python dependencies for the project.

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <your-repo-url>
    cd minirag
    ```
2.  **Create and activate a virtual environment:**
    ```bash
    python -m venv dev
    # On Windows:
    .\dev\Scripts\activate
    # On macOS/Linux:
    source dev/bin/activate
    ```
3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Place your PDF documents:** Put your industrial safety PDF files into the `src/documents/` directory.
5.  **Update `src/sources.json`:** Ensure `src/sources.json` lists the titles and URLs of your documents.

## How to Run

1.  **Ingest Documents:**
    First, populate the database with your document chunks and embeddings.
    ```bash
    cd src
    python ingest.py
    cd ..
    ```
    This will create (or update) `src/chunks.db`.

2.  **Run the FastAPI Server:**
    Open a terminal, navigate to the `src` directory, and start the API server.
    ```bash
    cd src
    python api.py
    ```
    The API will be available at `http://localhost:8000`. Keep this terminal open and running.

3.  **Run the Streamlit Application:**
    Open a *new* terminal, navigate to the `src` directory, and start the Streamlit app.
    ```bash
    cd src
    streamlit run streamlit_app.py
    ```
    This will open the Q&A interface in your web browser.

## Performance Test Results

Here's an example output from running `python src/performance_test.py`:

| Question                                                               | Answer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Sources                                                                                        | Top Context Score | Processing Time (s) | Reranker Used | Status  | Error Detail |
|:-----------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------|--------------------:|----------------------:|:--------------|:--------|:-------------|
| What are the main principles of machine safety?                        | the most rapidly growing areas of importance in industrial automation. PART 1 – THEORY AND BACKGROUND 7 — Safety and functional safety The purpose of safety is to protect people and the environment from accidents and risks caused by machines. Functional safety systems do this by lowering the probability of undesired events, so that mishaps are minimized when operating machinery. Safety standards define safety as freedom from unacceptable risk....                                       | https://example.com/EN_TechnicalguideNo10_REVF.pdf                                    |                 0.8 |                  2.67 | True          | Success |              |
| Explain the concept of Performance Level (PL) in safety systems.       | level (PL): Capability of safety-related components to perform a safety function under foreseea‐ ble conditions in order to achieve the expected reduction in risk • PFHD: Probability of a dangerous failure per hour • SIL: Discrete level for defining the integrity of the safety function. ISO 13849-1 IEC 62061 Sensor Logic Power c ontrol elements Sensor Logic PL PL ? P FHD SIL PFHD SIL ? ?...                                                                                                | https://example.com/special_information_guide_for_safe_machinery_en_im0014678.pdf |                 0.8 |                  2.67 | True          | Success |              |
| What is an emergency stop and how should it be implemented?            | Edition of IEC/EN 60204-1 will expand the types of Category 1 stop. Category 2 is a controlled stop with power left available to the machine actuators. A normal production stop is considered a category 2 stop. These stop categories must be applied to each stop function, where the stop function is the action taken by the safety related parts of the control system in response to an input, category 0 or 1 should be used. Stop functions must override related start functions....           | https://example.com/safebk-rm002_-en-p.pdf                                    |                 0.8 |                  2.66 | True          | Success |              |
| What is the role of ISO 13849 in functional safety?                    | worth noting that neither EN ISO 13849-1 nor EN 62061 cover the general electrical safety aspects for machinery, this is the subject of EN 60204. So it is only once it has been decided that further risk reduction is required from safeguards utilising safety related controls that we should consider the guidance given by either EN ISO 13849-1 or EN 62061....                                     | https://example.com/uk-mkg-practical-guide-en-GB-A4.pdf                               |                 0.8 |                  2.64 | True          | Success |              |
| Describe different types of machine guarding.                          | may not be used for all maintenance and servic- ing work....                                                     | https://example.com/osha3170.pdf                                        |                 0.8 |                  2.89 | True          | Success |              |
| What are the requirements for robot safety in industrial environments? | safeguarding strategy to protect workplaces involving industrial robots. Following are some of the essential steps industrial businesses must take to ensure a safe workplace environment when integrating robots. Safety Considerations for Industrial Robots Safety standards review At the manufacturer level, it is essential to comply with applicable safety regulations and standards when designing robot applications. These guidelines and specifications help create a safe working environment.... | https://example.com/Hokuyo-USA_-_A_Safety_Guide_to_Industrial_Robotics_Hazards_-_Whitepaper.pdf |                 0.8 |                  2.61 | True          | Success |              |
| How does risk assessment contribute to machinery safety?               | following can be applied to an existing factory installation or a single new machine. MACHINERY SAFEBOOK 5 Safety related control systems for machinery 24 Risk Assessment It is wrong to regard risk assessment as a burden. It is a helpful process that provides vital information and empowers the user or designer to take logical decisions about ways of achieving safety. There are various standards that cover this subject....                                                                | https://example.com/safebk-rm002_-en-p.pdf                                    |                 0.8 |                  2.63 | True          | Success |              |
| What are the common hazards associated with industrial robots?         | A Safety Guide to Industrial Robotics Hazards HOKUYO USA 2019 Van Buren Ave., Suite A, Indian Trail, NC 28079 CONTACT 704-882-3844 info@hokuyo-usa.com Table of Contents What are Industrial Robots? The Exponential Rise in the Use of Industrial Robotics Do Industrial Robots Improve Workplace Safety? Are Industrial Robots Completely Safe?...                                                       | https://example.com/Hokuyo-USA_-_A_Safety_Guide_to_Industrial_Robotics_Hazards_-_Whitepaper.pdf |                 0.8 |                  2.68 | True          | Success |              |

## What Was Learned (Debugging Insights)

During the development and debugging of this RAG system, several key issues were identified and resolved. Initially, the `test_api.py` script incorrectly reported an "empty database" due to a mismatch in how it parsed the `chunk_count` from the API's health check response. This was fixed by accurately extracting the count from the `message` field.

The most challenging problem was a persistent "ambiguous truth value" error arising during query processing. This was ultimately traced to an incorrect interpretation of embedding data loaded from `chunks.db`. The `np.frombuffer` function in `src/api.py` was not explicitly given a `dtype`, causing it to default to `uint8` instead of `float32`. This led to malformed NumPy arrays and subsequent failures in numerical operations like `np.linalg.norm()`. The solution involved explicitly setting `dtype=np.float32` during embedding loading and then performing a full re-ingestion of documents to ensure all embeddings in `chunks.db` were correctly generated and stored as 384-dimensional `float32` vectors. Finally, isolating and re-enabling the `BM25Okapi` calculation confirmed that the data integrity issue was the root cause, and the hybrid search now functions as intended.

## Example `curl` Requests

Here are two example `curl` requests to interact with the `/ask` endpoint:

**1. Easy Query (Baseline Mode):**
```bash
curl -X POST "http://localhost:8000/ask" -H "Content-Type: application/json" -d "{
  "q": "What is safety?",
  "k": 3,
  "mode": "baseline"
}"

```

**2. Tricky Query (Hybrid Mode with specific alpha):**
```bash
curl -X POST "http://localhost:8000/ask" -H "Content-Type: application/json" -d "{
  "q": "What measures prevent robot arm collisions with human operators?",
  "k": 5,
  "mode": "hybrid",
  "alpha": 0.7
}"
```
